# Mineração de Padrões

## Visão Geral
A mineração de padrões frequentes busca regularidades em dados transacionais e sequenciais. A partir de padrões frequentes, derivam-se regras de associação com medidas como suporte, confiança e lift.  
Slides: 1–5.

## Configuração

```{r}
# Slides 1–3: contexto
# DAL ToolBox
# version 1.0.77

library(daltoolbox)

library(arules)
library(arulesViz)
library(arulesSequences)
library(igraph)
```

```{r}
# Slide 2–4: exemplo transacional
data(AdultUCI)
myAdultUCI <- as.data.frame(AdultUCI)
dim(myAdultUCI)
head(myAdultUCI)
```

## Pré-processamento e Hierarquias Conceituais
A discretização e a criação de níveis agregados ajudam a reduzir a cardinalidade e a revelar padrões em diferentes granularidades.  
Slides: 5–9.

```{r}
# Removing attributes
myAdultUCI$fnlwgt <- NULL
myAdultUCI$"education-num" <- NULL
```

```{r}
# Conceptual Hierarchy and Binning
print(0)

myAdultUCI$age <- ordered(cut(myAdultUCI$age, c(15,25,45,65,100)),
                              labels = c("Young", "Middle-aged", "Senior", "Old"))

print(1)

myAdultUCI$"hours-per-week" <- ordered(cut(myAdultUCI$"hours-per-week",
                                             c(0,25,40,60,168)),
                                         labels = c("Part-time", "Full-time", "Over-time", "Workaholic"))

print(2)

myAdultUCI$"capital-gain" <- ordered(cut(myAdultUCI$"capital-gain",
                                           c(-Inf,0,median(myAdultUCI$"capital-gain"[myAdultUCI$"capital-gain">0]),
                                             Inf)), labels = c("None", "Low", "High"))

print(3)

myAdultUCI$"capital-loss" <- ordered(cut(myAdultUCI$"capital-loss",
                                           c(-Inf,0, median(myAdultUCI$"capital-loss"[myAdultUCI$"capital-loss">0]),
                                             Inf)), labels = c("None", "Low", "High"))

print(4)

head(myAdultUCI)
```

## Conversão para Transações
Dados transacionais são a base para Apriori, ECLAT e regras de associação.  
Slides: 2–5.

```{r}
# Convert to transactions
AdultTrans <- as(myAdultUCI, "transactions")
```

## Apriori
Apriori explora a propriedade anti-monótona do suporte para gerar e podar candidatos.  
Slides: 10–20.

```{r}
# A Priori
rules <- apriori(AdultTrans, parameter=list(supp = 0.5, conf = 0.9, minlen=2, maxlen= 10, target = "rules"),
                 appearance=list(rhs = c("capital-gain=None"), default="lhs"), control=NULL)
inspect(rules)
```

```{r}
rules_a <- as(rules, "data.frame")
head(rules_a)
```

## ECLAT e Itemsets Frequentes
ECLAT usa representação vertical, eficiente para contagem de suportes.  
Slides: 22–24.

```{r}
# ECLAT (itemsets frequentes)
itemsets_eclat <- eclat(AdultTrans, parameter = list(supp = 0.5, maxlen = 3))
inspect(head(sort(itemsets_eclat, by = "support")))
```

## Padrões Fechados e Max-Padrões
Padrões fechados preservam suporte; max-padrões reduzem ainda mais o volume, mas perdem detalhes.  
Slides: 6–9.

```{r}
# Padrões fechados e max-padrões
closed_sets <- itemsets_eclat[is.closed(itemsets_eclat)]
max_sets <- itemsets_eclat[is.maximal(itemsets_eclat)]

inspect(head(sort(closed_sets, by = "support")))
inspect(head(sort(max_sets, by = "support")))
```

## Medidas de Interesse
Além de suporte e confiança, métricas como lift, leverage e conviction ajudam a priorizar regras.  
Slides: 4–5, 21.

```{r}
# Analysis of Rules
imrules <- interestMeasure(rules, transactions = AdultTrans)
head(imrules)
```

```{r}
imrules2 <- interestMeasure(rules, c("support", "confidence", "lift", "leverage", "conviction"), AdultTrans)
head(imrules2[order(imrules2[, "lift"], decreasing = TRUE), ])
```

## Redundância e Interpretação
Redução de redundância evita regras repetitivas ou pouco informativas.  
Slides: 21–24.

```{r}
# Removing redundant rules
nrules <- rules[!is.redundant(rules)]

arules::inspect(nrules)
```

## Transações de Suporte
Analisar quais transações suportam regras ajuda a validar padrões.  
Slides: 4–5.

```{r}
# Showing the transactions that support the rules
st <- supportingTransactions(nrules[1], AdultTrans)
trans <- unique(st@data@i)
length(trans)
print(c(length(trans)/length(AdultTrans), nrules[1]@quality$support))
```

```{r}
# Supporting transactions for multiple rules
st <- supportingTransactions(nrules[1:2], AdultTrans)
trans <- unique(st@data@i)
length(trans)
print(c(length(trans)/length(AdultTrans), nrules[1:2]@quality$support))
```

## Visualização de Regras
Visualizações auxiliam a interpretação de padrões descobertos.  
Slides: 21.

```{r}
# Rules visualization
options(repr.plot.width=10, repr.plot.height=5)
plot(rules)
```

```{r}
options(repr.plot.width=10, repr.plot.height=5)
plot(rules, method="paracoord", control=list(reorder=TRUE))
```

## Padrões Raros e Negativos
Padrões raros podem ser estratégicos; padrões negativos indicam correlação inversa (lift < 1).  
Slides: 39.

```{r}
# Padrões raros e negativos
rare_rules <- apriori(AdultTrans, parameter = list(supp = 0.05, conf = 0.6, minlen = 2, maxlen = 3))
neg_rules <- subset(rare_rules, lift < 1)
length(neg_rules)
inspect(head(neg_rules))
```

## Associações Multi-Nível e Multi-Dimensionais
Regras podem incorporar dimensões adicionais, como atributos demográficos, com suportes adequados por nível.  
Slides: 30–35.

```{r}
# Associações multi-nível e multi-dimensionais
adult_ml <- myAdultUCI
adult_ml$edu_level <- factor(ifelse(adult_ml$education %in% c("Bachelors", "Masters", "Doctorate", "Prof-school"),
                                    "Higher", "Lower"))

AdultTransML <- as(adult_ml, "transactions")
income_labels <- paste0("income=", levels(adult_ml$income))

rules_md <- apriori(AdultTransML,
                    parameter = list(supp = 0.2, conf = 0.6, minlen = 2, maxlen = 3),
                    appearance = list(rhs = income_labels, default = "lhs"))
inspect(rules_md)
```

## Mineração de Sequências
Padrões sequenciais estendem itemsets para ordem temporal. SPADE é uma abordagem vertical eficiente.  
Slides: 46–62.

```{r}
# Sequence Mining
x <- read_baskets(con = system.file("misc", "zaki.txt", package = "arulesSequences"), info = c("sequenceID","eventID","SIZE"))
as(x, "data.frame")
```

```{r}
s1 <- cspade(x, parameter = list(support = 0.4), control = list(verbose = TRUE))
as(s1, "data.frame")
```

## Graph Pattern Mining (Exemplo)
Em grafos, padrões frequentes são subgrafos recorrentes. Aqui mostramos contagem de subgrafos como ilustração.  
Slides: 63–64.

```{r}
# Graph Pattern Mining (toy example)

g1 <- make_ring(4)
g2 <- make_full_graph(3)
g3 <- make_star(4, mode = "undirected")
tri <- make_full_graph(3)

count_subgraph_isomorphisms(tri, g1)
count_subgraph_isomorphisms(tri, g2)
count_subgraph_isomorphisms(tri, g3)
```

## Referências
- Han, J., Pei, J., & Tong, H. (2022). *Data Mining: Concepts and Techniques* (4th ed.). Morgan Kaufmann.
- Agrawal, R., & Srikant, R. (1994). Fast algorithms for mining association rules. *VLDB*.
- Zaki, M. (2001). SPADE: An efficient algorithm for mining frequent sequences. *Machine Learning*, 42(1), 31–60.
- Geng, L., & Hamilton, H. (2006). Interestingness measures for data mining: A survey. *ACM Computing Surveys*, 38(3).
- McGarry, K. (2005). A survey of interestingness measures for knowledge discovery. *Knowledge Engineering Review*, 20(1).
- Borgelt, C. (2005). An implementation of the FP-growth algorithm. *ACM SIGKDD Explorations*.
- Yan, X., & Han, J. (2002). gSpan: Graph-based substructure pattern mining. *ICDM*.
